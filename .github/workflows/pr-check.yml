name: PR Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm run install:all

    - name: Run linter
      run: npm run lint

    - name: Run tests with coverage
      run: npm run test
      env:
        CI: true

    - name: Build application
      run: npm run build

    - name: Check bundle size
      run: |
        cd frontend
        npm run analyze || echo "Bundle analysis completed"

    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ğŸ¤– PR ì²´í¬ ê²°ê³¼')
          );
          
          const success = '${{ job.status }}' === 'success';
          const status = success ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨';
          
          const body = `ğŸ¤– PR ì²´í¬ ê²°ê³¼: ${status}
          
          **ì²´í¬ í•­ëª©:**
          - ë¦°í„° ê²€ì‚¬: ${success ? 'âœ…' : 'âŒ'}
          - í…ŒìŠ¤íŠ¸ ì‹¤í–‰: ${success ? 'âœ…' : 'âŒ'}
          - ë¹Œë“œ í™•ì¸: ${success ? 'âœ…' : 'âŒ'}
          
          ${success ? 'ëª¨ë“  ì²´í¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‰' : 'ì¼ë¶€ ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
          } 